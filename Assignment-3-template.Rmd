---
title: "Rotterdam School of Management - DMA - Individual Assignment 3"
author: "Andrea Montalto 591528am"
date: "05/22/2024"
output: html_document
---


## Working directory

```{r}
# Set working directory (change it to your own working directory and run)
# setwd("C:/Users/Desktop/courses/DMA/Individual Assignment 3")
```


## Packages

```{r}
# Load packages (and install them if they are not already installed)
# e.g., install.packages("wooldridge")
install.packages("plm")
library(wooldridge)
library(zoo)
library(dynlm)
library(Hmisc)
library(car)
library(plm)
library(Rcpp)
library(ggplot2)
library(dplyr)  
library(lmtest)
library(stargazer)
library(sandwich)
library(fpp2)
library(readxl)
```

## Part A: Time series `[12 points]`

You probably have heard that there is a shortage of tomatoes in the UK (e.g., https://www.bbc.com/news/64762429). While many possible factors can influence supplies of tomatoes, in Part A we’re going to help Lucy investigate the relationship between tomato price and the agricultural investment in planting tomatoes using the time series data “tomato.xlsx” collected during 1979-2020 in an anonymous area in the UK. The description of variables is as follows:

-   year: 1979-2020
-   tomaPri: tomato price index; 2014 = 1
-   agrInv: agricultural investment on planting tomatoes, millions £
 
1.  `[3 points]` Lucy wants to fit a FDL model of order q to investigate the effect of tomaPri on agrInv. However, she doesn’t know how big the q should be and how many lags of tomaPri should be included in the model. She has checked the literature and found that the order q should be smaller or equal to 15 and she needs to choose a value out of 1, 2, 3, …, 15. Please help her to choose a “best” value of order q by choosing a value of order q such that the AIC of FDL model is minimized (let’s use Q to denote this “best” value). Make sure you print the AIC values of FDL models of different orders in R (there should be two columns: one column shows AIC values and the other column shows the orders of the corresponding FDL models). What is the value of order q that you choose (i.e., how big is Q)?  
    
    ```{r   }
    #reading dataset
    tomato_raw <- read_xlsx('tomato.xlsx')
    
    #Creating ts object
    tomato_ts <- ts(tomato_raw[, c("tomaPri", "agrInv")], start = c(1979), frequency = 1)
  
  # Set up the q values vector
    q_vector <- c(1:15)     
    aic_results <- as.data.frame(q_vector, col.names = c("q_value"))
    
  # Define a function that returns aic value fot the model
    fn_aic <- function(q_value) {
       ts_estimated <- dynlm(formula = agrInv ~ tomaPri + L(tomaPri, 1:q_value), data = tomato_ts)
      return(extractAIC(ts_estimated)[2])
     }

    aic_results$aic_values <- sapply(q_vector, fn_aic)
   #ANSWER:
     paste("The best order q is", aic_results$q_vector[which.min(aic_results$aic_values)])
    ```

2.  `[1 point]` Use the command “dynlm” to fit a FDL model of order Q. 
    
    ```{r   }
    model_dynlm <- dynlm(formula = agrInv ~ tomaPri + L(tomaPri, 1), data = tomato_ts)
    ```

3.  `[2 points]` Which model should Lucy choose, the FDL model of order Q or just a simple linear regression of agrInv (DV) on tomaPri (IV)? Apply a test and explain the results. 
    
    ```{r   }
    model_lm <- lm(agrInv ~ tomaPri, data = tomato_raw)
    linearHypothesis(model_lm, "tomaPri")
    linearHypothesis(model_dynlm, c("tomaPri", "L(tomaPri, 1)"))
    
    # ANSWER: Lucy should use the FDL model since it shows a p-value that is more significant in comparison to the lm model
    ```

4.  `[2 points]` Test whether there exists significant heteroskedasticity and whether there exists significant serial correlation of order 3 for the FDL model of order Q. Based on the test results, which standard errors should you use, the original standard errors generated by using “dynlm” command, HC standard errors or HAC standard errors? Please explain your answer and show the regression results again with the standard errors chosen by you. 
    
    ```{r   }
   #testing for heteroskedasticity 
    bptest(model_dynlm) #p-value > 0.05 meaning that the null hypothsis that the variance of error term is constant is accepted. As a consequence there is no heteroskedasticity 
    
   #testing for serial correlation of order 3 
    bgtest(model_dynlm, order = 3) #results give a p-value <0.05 meaning that there is strong evidence for serial correlation
    
    #ANSWER: Considering the results of the two tests we will need to use HAC standard errors due to the presence of serial correlation of order 3.
    
  summary(model_dynlm)
  coeftest(model_dynlm, vcovHAC) #with the HAC standard errors the lagged IV becomes looses significance (smaller p-value)
    ```

5.  `[2 points]` Based on the FDL model of order Q and your chosen standard errors in question 4, calculate the estimated value of long-run propensity (LRP) of variable tomaPri, and test whether this LRP is significant. Interpret LRP. 
    
    ```{r   }
    b <- coef(coeftest(model_dynlm, vcovHAC))
   
    
    ```

6.  `[2 points]` Lucy wants to do forecasting for the variable “agrInv”. Help her to fit a seasonal ARIMA model for “agrInv” and run diagnostics on this ARIMA model in R. Explain the results. 


    
    ```{r   }
arima_model <- auto.arima(tomato_ts[,2])
    checkresiduals(arima_model)
    model_forecast <- forecast(arima_model)
autoplot(model_forecast) + ylab("Australian beer production") + 
  xlab("Year/Quarter") + ggtitle("Forecasted beer production") 
    ```

## Part B: Panel data `[13 points]`

It’s a well-known fact that burning gasoline produces carbon dioxide, increasing the greenhouse effect and global warming. In part B, we’re going to investigate the possible factors that influence gasoline consumption by using the data “Gasoline”. Please import this data from the “plm” package in R. Please see the following link for the description of variables: https://rdrr.io/cran/plm/man/Gasoline.html 
 
1.  `[1 point]` Create a new variable (a new column) called “m_lincomep” in the data “Gasoline” such that, for every entity, the value of the variable “m_lincomep” is the mean of lincomep across different years. Show the first 10 rows and the last 10 rows of data “Gasoline”. 
    
    ```{r   }
    # <Answer here>
    ```


2.  `[2 points]` Make the following two plots. 

    - Plot 1: A plot of dependent variable lgaspcar and year for every entity.   
    - Plot 2: A plot for fixed effects to show heterogeneity across entities.
    
Note for Plot 1: The format of the plot should be similar to the example plot presented in the videos. In the plot, there should be a line for every entity. Make sure that the labels of your plot are clear to see.
    
Note for Plot 2: The dependent variable is still lgaspcar. The format of the plot should be similar to the example plot presented in the videos. In the plot, there should be black points and a red line. Make sure that the labels of your plot are clear to see. 

What do you observe from the two plots? Please describe the two plots. Based on the two plots, do you think whether the individual fixed effects should be considered or not? Please explain why you think the individual fixed effects should or shouldn’t be considered.


```{r}
# <Answer here>
```



3.  `[2 points]` Use the command “lm” to fit a least squares dummy variable (LSDV) model that considers individual fixed effects: 
    -	Dependent variable: lgaspcar
    -   Independent variables: lincomep, lrpmg, lcarpcap, etc. 

    Based on the regression result, test whether there is significant difference in logarithm of motor gasoline consumption per car between BELGIUM and GERMANY (hint: you may use the command “linearHypothesis”).
    
    ```{r   }
    # <Answer here>
    ```

4.  `[2 points]` Use the command “plm” to estimate a FE estimator (or within estimator) that considers individual fixed effects: 
    -   Dependent variable: lgaspcar
    -   Independent variables: lincomep, lrpmg and lcarpcap

    Should you add time-fixed effects to this FE model? In other words, should you choose a FE estimator with both individual and time-fixed effects or only with individual fixed effects? Please provide an explanation about how you make the decision.
    
    ```{r   }
    # <Answer here>
    ```

5.  `[2 points]` Instead of using variable lincomep as an independent variable, Lucy wants to use m_lincomep as an independent variable. Can she get an estimated coefficient on the variable m_lincomep if she uses a FE model, yes or no? Please provide an explanation for your answer. 
    
    ```{r   }
    # <Answer here>
    ```

6.  `[2 points]` In the following analysis, the dependent variable is still lgaspcar. The independent variables are based on the model chosen by you in question 4: 
    -   If in question 4 you choose a model that doesn’t include time-fixed effects, then in the following analysis, your independent variables are lincomep, lrpmg, and lcarpcap.  
    -   If in question 4 you choose a model that includes time-fixed effects, then in the following analysis, please take the time-fixed effects into consideration by including year dummies as your independent variables in your regressions. So, your independent variables are lincomep, lrpmg, lcarpcap, and year dummies. 

    Estimate a pooled OLS model, a FE model, and a RE model using the above dependent variable and independent variables. Use the command “stargazer” to make a table of the results:
    
    -   column (1) shows the result of pooled OLS    
    -   column (2) shows the result of the FE model
    -   column (3) shows the result of the RE model

Only include variables income, lrpmg, and lcarpcap in the table. Which model should you choose among pooled OLS, FE model, and RE model? Please explain how you make the decision. Based on your final chosen model, is the coefficient on lrpmg significant or not?

```{r}
# <Answer here>
```


7.  `[2 points]` Test whether there is considerable serial correlation in your chosen model of question 6. Based on the test, should you use the standard errors that you get in question 6 or the robust standard errors? Please explain how you make the decision. Based on the decision, will you change your conclusion about whether lrpmg  is significant or not? If you decide to use robust standard errors, please calculate the robust standard errors and use the command “stargazer” to make a table of your results:
    -   column (1) shows the result of your chosen model with standard errors in question 6
    -   column (2) shows the result of your chosen model with robust standard errors 

Only include variables lincomep, lrpmg, and lcarpcap in the table 
    
```{r}
# <Answer here>
```



